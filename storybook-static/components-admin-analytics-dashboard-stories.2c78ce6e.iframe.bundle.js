"use strict";(self.webpackChunkcasaora=self.webpackChunkcasaora||[]).push([[52136,91797],{"./src/components/admin/analytics-dashboard.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,__namedExportsOrder:()=>__namedExportsOrder,default:()=>analytics_dashboard_stories});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),browser_client=__webpack_require__("./src/lib/supabase/browser-client.ts"),console=__webpack_require__("./node_modules/console-browserify/index.js");function MetricCard({title,value,description,trend}){return(0,jsx_runtime.jsxs)("div",{className:`rounded-2xl border-2 ${{good:"border-slate-900 dark:border-slate-100/40 bg-slate-900 dark:bg-slate-100/10",neutral:"border-slate-900 dark:border-slate-100/40 bg-slate-900 dark:bg-slate-100/10",poor:"border-slate-900 dark:border-slate-100 bg-white dark:bg-slate-950"}[trend]} p-6 hover:shadow-md transition-shadow`,children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-start justify-between",children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-slate-600 dark:text-slate-400 text-sm uppercase tracking-wide",children:title}),(0,jsx_runtime.jsx)("span",{className:"text-2xl",children:{good:"↗",neutral:"→",poor:"↘"}[trend]})]}),(0,jsx_runtime.jsx)("p",{className:"mt-3 font-bold text-4xl text-slate-900 dark:text-slate-100",children:value}),(0,jsx_runtime.jsx)("p",{className:"mt-1 text-slate-600 dark:text-slate-400 text-sm",children:description})]})}const analytics_dashboard_stories={title:"Admin/Analytics Dashboard",component:function AnalyticsDashboard(){const[metrics,setMetrics]=(0,react.useState)(null),[cityMetrics,setCityMetrics]=(0,react.useState)([]),[categoryMetrics,setCategoryMetrics]=(0,react.useState)([]),[isLoading,setIsLoading]=(0,react.useState)(!0),[selectedTimeRange,setSelectedTimeRange]=(0,react.useState)("30d"),loadAnalytics=(0,react.useCallback)(async()=>{setIsLoading(!0);try{const supabase=(0,browser_client.createSupabaseBrowserClient)(),now=new Date;let startDate=null;if("all"!==selectedTimeRange){startDate=new Date(now);const days="7d"===selectedTimeRange?7:"30d"===selectedTimeRange?30:90;startDate.setDate(startDate.getDate()-days)}let bookingsQuery=supabase.from("bookings").select("\n        id,\n        status,\n        created_at,\n        scheduled_start,\n        customer_id,\n        professional_id,\n        amount_estimated,\n        service_category,\n        city\n      ");startDate&&(bookingsQuery=bookingsQuery.gte("created_at",startDate.toISOString()));const{data:bookings}=await bookingsQuery,{data:professionals}=await supabase.from("profiles").select("id, role, created_at, approval_date").eq("role","professional"),{data:customers}=await supabase.from("profiles").select("id").eq("role","customer"),totalBookings=bookings?.length||0,acceptedBookings=bookings?.filter(b=>"cancelled"!==b.status&&"pending_payment"!==b.status).length||0,fillRate=totalBookings>0?acceptedBookings/totalBookings*100:0,proFirstBookings=professionals?.map(pro=>{const firstBooking=bookings?.filter(b=>b.professional_id===pro.id&&"cancelled"!==b.status).sort((a,b)=>new Date(a.created_at).getTime()-new Date(b.created_at).getTime())[0];if(!firstBooking||!pro.approval_date)return null;const approvalDate=new Date(pro.approval_date),firstBookingDate=new Date(firstBooking.created_at),daysDiff=Math.floor((firstBookingDate.getTime()-approvalDate.getTime())/864e5);return daysDiff>=0?daysDiff:null}).filter(days=>null!==days),avgTimeToFirstBooking=proFirstBookings&&proFirstBookings.length>0?proFirstBookings.reduce((sum,days)=>sum+days,0)/proFirstBookings.length:0,customerBookingCounts=new Map;bookings?.forEach(booking=>{booking.customer_id&&"cancelled"!==booking.status&&customerBookingCounts.set(booking.customer_id,(customerBookingCounts.get(booking.customer_id)||0)+1)});const customersWithMultipleBookings=Array.from(customerBookingCounts.values()).filter(count=>count>=2).length,totalUniqueCustomers=customerBookingCounts.size,repeatBookingRate=totalUniqueCustomers>0?customersWithMultipleBookings/totalUniqueCustomers*100:0,thirtyDaysAgo=new Date;thirtyDaysAgo.setDate(thirtyDaysAgo.getDate()-30);const activeProfessionalIds=new Set(bookings?.filter(b=>new Date(b.created_at)>=thirtyDaysAgo&&"cancelled"!==b.status).map(b=>b.professional_id));setMetrics({fillRate,avgTimeToFirstBooking,repeatBookingRate,totalBookings,totalProfessionals:professionals?.length||0,totalCustomers:customers?.length||0,activeProfessionals:activeProfessionalIds.size});const citiesMap=new Map;bookings?.forEach(booking=>{const city=booking.city||"Unknown";citiesMap.has(city)||citiesMap.set(city,{total:0,accepted:0,professionals:new Set,ttfbDays:[]});const cityData=citiesMap.get(city);cityData.total++,"cancelled"!==booking.status&&"pending_payment"!==booking.status&&cityData.accepted++,booking.professional_id&&cityData.professionals.add(booking.professional_id)}),professionals?.forEach(pro=>{const firstBooking=bookings?.filter(b=>b.professional_id===pro.id&&"cancelled"!==b.status).sort((a,b)=>new Date(a.created_at).getTime()-new Date(b.created_at).getTime())[0];if(firstBooking&&pro.approval_date&&firstBooking.city){const approvalDate=new Date(pro.approval_date),firstBookingDate=new Date(firstBooking.created_at),daysDiff=Math.floor((firstBookingDate.getTime()-approvalDate.getTime())/864e5);if(daysDiff>=0){const cityData=citiesMap.get(firstBooking.city);cityData&&cityData.ttfbDays.push(daysDiff)}}});const cityMetricsArray=Array.from(citiesMap.entries()).map(([city,data])=>({city,fillRate:data.total>0?data.accepted/data.total*100:0,avgTimeToFirstBooking:data.ttfbDays.length>0?data.ttfbDays.reduce((sum,d)=>sum+d,0)/data.ttfbDays.length:0,bookingCount:data.total,professionalCount:data.professionals.size})).sort((a,b)=>b.bookingCount-a.bookingCount);setCityMetrics(cityMetricsArray);const categoriesMap=new Map;bookings?.forEach(booking=>{const category=booking.service_category||"Unknown";categoriesMap.has(category)||categoriesMap.set(category,{total:0,accepted:0,totalAmount:0});const categoryData=categoriesMap.get(category);categoryData.total++,"cancelled"!==booking.status&&"pending_payment"!==booking.status&&(categoryData.accepted++,categoryData.totalAmount+=booking.amount_estimated||0)});const categoryMetricsArray=Array.from(categoriesMap.entries()).map(([category,data])=>({category,fillRate:data.total>0?data.accepted/data.total*100:0,bookingCount:data.total,avgPrice:data.accepted>0?data.totalAmount/data.accepted:0})).sort((a,b)=>b.bookingCount-a.bookingCount);setCategoryMetrics(categoryMetricsArray)}catch(error){console.error("Failed to load analytics:",error)}finally{setIsLoading(!1)}},[selectedTimeRange]);return(0,react.useEffect)(()=>{loadAnalytics()},[loadAnalytics]),isLoading?(0,jsx_runtime.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,jsx_runtime.jsx)("div",{className:"text-slate-600 dark:text-slate-400 text-base",children:"Loading analytics..."})}):metrics?(0,jsx_runtime.jsxs)("div",{className:"space-y-8",children:[(0,jsx_runtime.jsx)("div",{className:"flex justify-end gap-2",children:["7d","30d","90d","all"].map(range=>(0,jsx_runtime.jsx)("button",{className:"rounded-lg px-4 py-2 font-semibold text-sm transition-all "+(selectedTimeRange===range?"bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-950 shadow-md":"border border-slate-200 dark:border-slate-800 text-slate-900 dark:text-slate-100 hover:border-slate-900 dark:border-slate-100 hover:text-slate-900 dark:text-slate-100"),onClick:()=>setSelectedTimeRange(range),children:"all"===range?"All Time":"7d"===range?"7 Days":"30d"===range?"30 Days":"90 Days"},range))}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4",children:[(0,jsx_runtime.jsx)(MetricCard,{description:"Booking requests accepted",title:"Fill Rate",trend:metrics.fillRate>=70?"good":metrics.fillRate>=50?"neutral":"poor",value:`${metrics.fillRate.toFixed(1)}%`}),(0,jsx_runtime.jsx)(MetricCard,{description:"Avg. professional onboarding",title:"Time to First Booking",trend:metrics.avgTimeToFirstBooking<=7?"good":metrics.avgTimeToFirstBooking<=14?"neutral":"poor",value:`${metrics.avgTimeToFirstBooking.toFixed(1)} days`}),(0,jsx_runtime.jsx)(MetricCard,{description:"Customers with 2+ bookings",title:"Repeat Booking Rate",trend:metrics.repeatBookingRate>=40?"good":metrics.repeatBookingRate>=25?"neutral":"poor",value:`${metrics.repeatBookingRate.toFixed(1)}%`}),(0,jsx_runtime.jsx)(MetricCard,{description:"Bookings in last 30 days",title:"Active Professionals",trend:metrics.activeProfessionals/metrics.totalProfessionals>=.5?"good":"neutral",value:`${metrics.activeProfessionals} / ${metrics.totalProfessionals}`})]}),(0,jsx_runtime.jsxs)("div",{className:"grid grid-cols-1 gap-6 md:grid-cols-3",children:[(0,jsx_runtime.jsxs)("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 hover:border-slate-900 dark:border-slate-100 transition-all",children:[(0,jsx_runtime.jsx)("h3",{className:"mb-2 font-semibold text-slate-600 dark:text-slate-400 text-sm uppercase tracking-wide",children:"Total Bookings"}),(0,jsx_runtime.jsx)("p",{className:"font-bold text-4xl text-slate-900 dark:text-slate-100",children:metrics.totalBookings})]}),(0,jsx_runtime.jsxs)("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 hover:border-slate-900 dark:border-slate-100 transition-all",children:[(0,jsx_runtime.jsx)("h3",{className:"mb-2 font-semibold text-slate-600 dark:text-slate-400 text-sm uppercase tracking-wide",children:"Total Professionals"}),(0,jsx_runtime.jsx)("p",{className:"font-bold text-4xl text-slate-900 dark:text-slate-100",children:metrics.totalProfessionals})]}),(0,jsx_runtime.jsxs)("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 hover:border-slate-900 dark:border-slate-100 transition-all",children:[(0,jsx_runtime.jsx)("h3",{className:"mb-2 font-semibold text-slate-600 dark:text-slate-400 text-sm uppercase tracking-wide",children:"Total Customers"}),(0,jsx_runtime.jsx)("p",{className:"font-bold text-4xl text-slate-900 dark:text-slate-100",children:metrics.totalCustomers})]})]}),(0,jsx_runtime.jsxs)("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-4 font-bold text-slate-900 dark:text-slate-100 text-xl",children:"Metrics by City"}),(0,jsx_runtime.jsx)("div",{className:"overflow-x-auto",children:(0,jsx_runtime.jsxs)("table",{className:"w-full",children:[(0,jsx_runtime.jsx)("thead",{className:"bg-white dark:bg-slate-950",children:(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"City"}),(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Fill Rate"}),(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Avg. TTFB"}),(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Bookings"}),(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Professionals"})]})}),(0,jsx_runtime.jsx)("tbody",{className:"divide-y divide-[#e2e8f0]",children:0===cityMetrics.length?(0,jsx_runtime.jsx)("tr",{children:(0,jsx_runtime.jsx)("td",{className:"px-6 py-8 text-center text-slate-600 dark:text-slate-400",colSpan:5,children:"No city data available"})}):cityMetrics.map((city,index)=>(0,jsx_runtime.jsxs)("tr",{className:"hover:bg-white dark:bg-slate-950 transition-colors "+(index%2==1?"bg-white dark:bg-slate-950/30":""),children:[(0,jsx_runtime.jsx)("td",{className:"px-6 py-4 font-semibold text-slate-900 dark:text-slate-100",children:city.city}),(0,jsx_runtime.jsx)("td",{className:"px-6 py-4",children:(0,jsx_runtime.jsxs)("span",{className:"inline-flex rounded-full px-3 py-1 font-semibold text-xs border "+(city.fillRate>=70||city.fillRate>=50?"bg-slate-900 dark:bg-slate-100/10 text-slate-900 dark:text-slate-100 border-slate-900 dark:border-slate-100/40":"bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 border-slate-900 dark:border-slate-100"),children:[city.fillRate.toFixed(1),"%"]})}),(0,jsx_runtime.jsx)("td",{className:"px-6 py-4 text-slate-600 dark:text-slate-400 text-sm",children:city.avgTimeToFirstBooking>0?`${city.avgTimeToFirstBooking.toFixed(1)} days`:"—"}),(0,jsx_runtime.jsx)("td",{className:"px-6 py-4 text-slate-900 dark:text-slate-100 text-sm font-medium",children:city.bookingCount}),(0,jsx_runtime.jsx)("td",{className:"px-6 py-4 text-slate-900 dark:text-slate-100 text-sm font-medium",children:city.professionalCount})]},city.city))})]})})]}),(0,jsx_runtime.jsxs)("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6",children:[(0,jsx_runtime.jsx)("h2",{className:"mb-4 font-bold text-slate-900 dark:text-slate-100 text-xl",children:"Metrics by Service Category"}),(0,jsx_runtime.jsx)("div",{className:"overflow-x-auto",children:(0,jsx_runtime.jsxs)("table",{className:"w-full",children:[(0,jsx_runtime.jsx)("thead",{className:"bg-white dark:bg-slate-950",children:(0,jsx_runtime.jsxs)("tr",{children:[(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Category"}),(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Fill Rate"}),(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Bookings"}),(0,jsx_runtime.jsx)("th",{className:"px-6 py-4 text-left font-semibold text-slate-900 dark:text-slate-100 text-sm uppercase tracking-wide",children:"Avg. Price"})]})}),(0,jsx_runtime.jsx)("tbody",{className:"divide-y divide-[#e2e8f0]",children:0===categoryMetrics.length?(0,jsx_runtime.jsx)("tr",{children:(0,jsx_runtime.jsx)("td",{className:"px-6 py-8 text-center text-slate-600 dark:text-slate-400",colSpan:4,children:"No category data available"})}):categoryMetrics.map((category,index)=>(0,jsx_runtime.jsxs)("tr",{className:"hover:bg-white dark:bg-slate-950 transition-colors "+(index%2==1?"bg-white dark:bg-slate-950/30":""),children:[(0,jsx_runtime.jsx)("td",{className:"px-6 py-4 font-semibold text-slate-900 dark:text-slate-100",children:category.category.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase())}),(0,jsx_runtime.jsx)("td",{className:"px-6 py-4",children:(0,jsx_runtime.jsxs)("span",{className:"inline-flex rounded-full px-3 py-1 font-semibold text-xs border "+(category.fillRate>=70||category.fillRate>=50?"bg-slate-900 dark:bg-slate-100/10 text-slate-900 dark:text-slate-100 border-slate-900 dark:border-slate-100/40":"bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 border-slate-900 dark:border-slate-100"),children:[category.fillRate.toFixed(1),"%"]})}),(0,jsx_runtime.jsx)("td",{className:"px-6 py-4 text-slate-900 dark:text-slate-100 text-sm font-medium",children:category.bookingCount}),(0,jsx_runtime.jsx)("td",{className:"px-6 py-4 text-slate-900 dark:text-slate-100 text-sm font-medium",children:category.avgPrice>0?`$${(category.avgPrice/100).toFixed(0)} COP`:"—"})]},category.category))})]})})]})]}):(0,jsx_runtime.jsx)("div",{className:"rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-8 text-center",children:(0,jsx_runtime.jsx)("p",{className:"text-slate-600 dark:text-slate-400 text-base",children:"No analytics data available"})})},parameters:{layout:"centered"},tags:["autodocs"]},Default={args:{}},__namedExportsOrder=["Default"]},"./src/lib/supabase/browser-client.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{createSupabaseBrowserClient:()=>createSupabaseBrowserClient});var _supabase_ssr__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@supabase/ssr/dist/module/index.js");function createSupabaseBrowserClient(){const supabaseUrl="https://hvnetxfsrtplextvtwfx.supabase.co",supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2bmV0eGZzcnRwbGV4dHZ0d2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODc0NTEsImV4cCI6MjA3NzE2MzQ1MX0.7-N06om_ntUuGP1NZ0Zcqz01s975xJfiKno34aIW__o";return(0,_supabase_ssr__WEBPACK_IMPORTED_MODULE_0__.createBrowserClient)(supabaseUrl,supabaseKey)}}}]);