"use strict";(self.webpackChunkcasaora=self.webpackChunkcasaora||[]).push([[52136,70853],{"./node_modules/next/dist/client/use-merged-ref.js":(module,exports,__webpack_require__)=>{Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"useMergedRef",{enumerable:!0,get:function(){return useMergedRef}});const _react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");function useMergedRef(refA,refB){const cleanupA=(0,_react.useRef)(null),cleanupB=(0,_react.useRef)(null);return(0,_react.useCallback)(current=>{if(null===current){const cleanupFnA=cleanupA.current;cleanupFnA&&(cleanupA.current=null,cleanupFnA());const cleanupFnB=cleanupB.current;cleanupFnB&&(cleanupB.current=null,cleanupFnB())}else refA&&(cleanupA.current=applyRef(refA,current)),refB&&(cleanupB.current=applyRef(refB,current))},[refA,refB])}function applyRef(refA,current){if("function"==typeof refA){const cleanup=refA(current);return"function"==typeof cleanup?cleanup:()=>refA(null)}return refA.current=current,()=>{refA.current=null}}("function"==typeof exports.default||"object"==typeof exports.default&&null!==exports.default)&&void 0===exports.default.__esModule&&(Object.defineProperty(exports.default,"__esModule",{value:!0}),Object.assign(exports.default,exports),module.exports=exports.default)},"./src/components/messaging/messaging-interface.stories.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{Default:()=>Default,__namedExportsOrder:()=>__namedExportsOrder,default:()=>messaging_interface_stories});var jsx_runtime=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),index_min=__webpack_require__("./node_modules/@hugeicons/core-free-icons/dist/esm/index.min.js"),HugeiconsIcon=__webpack_require__("./node_modules/@hugeicons/react/dist/esm/HugeiconsIcon.js"),formatDistanceToNow=__webpack_require__("./node_modules/date-fns/formatDistanceToNow.js"),next_image=__webpack_require__("./node_modules/@storybook/nextjs/dist/images/next-image.js"),react=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),quick_replies=__webpack_require__("./src/components/messaging/quick-replies.tsx"),skeleton=__webpack_require__("./src/components/ui/skeleton.tsx");var use_feature_flag=__webpack_require__("./src/hooks/use-feature-flag.ts"),console=__webpack_require__("./node_modules/console-browserify/index.js");const SENSITIVE_PATTERNS=[/\b\d{3,}\b/g,/\b[A-Z]\d+[A-Z]?\b/gi,/\b(?:code|código|clave|contraseña):\s*\S+/gi];async function translateText(text,sourceLang,targetLang){if(sourceLang===targetLang)return{translatedText:text};if(function hasSensitiveContent(message){return SENSITIVE_PATTERNS.some(pattern=>pattern.test(message))}(text))return{translatedText:text,error:"Contains sensitive information (not translated for safety)"};try{const response=await fetch("/api/messages/translate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text,sourceLanguage:sourceLang,targetLanguage:targetLang})});if(response.ok){return{translatedText:(await response.json()).translation}}throw new Error("Primary translation service unavailable")}catch(_primaryError){console.log("Falling back to LibreTranslate...");try{const response=await fetch("https://libretranslate.com/translate",{method:"POST",body:JSON.stringify({q:text,source:sourceLang,target:targetLang,format:"text"}),headers:{"Content-Type":"application/json"}});if(!response.ok)throw new Error("Fallback translation API error");return{translatedText:(await response.json()).translatedText}}catch(fallbackError){return console.error("Translation error:",fallbackError),{translatedText:text,error:"Translation unavailable"}}}}function detectLanguage(text){return[/\b(el|la|los|las|un|una|de|del|en|por|para|con|que|no|sí|está|son)\b/gi,/[áéíóúñ¿¡]/g].reduce((score,pattern)=>{const matches=text.match(pattern);return score+(matches?matches.length:0)},0)>2?"es":"en"}var browser_client=__webpack_require__("./src/lib/supabase/browser-client.ts"),use_realtime_messages_console=__webpack_require__("./node_modules/console-browserify/index.js");function normalizeUser(conversation,userRole){return"customer"===userRole?{id:conversation.professional.profile_id,full_name:conversation.professional.profile.full_name,avatar_url:conversation.professional.profile.avatar_url}:conversation.customer}function getConversationUnreadCount(conversation,userRole){return"customer"===userRole?conversation.customer_unread_count:conversation.professional_unread_count}var toast=__webpack_require__("./src/lib/toast.ts"),messaging_interface_console=__webpack_require__("./node_modules/console-browserify/index.js");function MessagingInterface({userId,userRole}){const[selectedConversation,setSelectedConversation]=(0,react.useState)(null),[previousUnreadCount,setPreviousUnreadCount]=(0,react.useState)(0),[isPending,startTransition]=(0,react.useTransition)(),{conversations,setConversations:_setConversations,loading,error,refetch:refetchConversations}=function useConversations(){const[conversations,setConversations]=(0,react.useState)([]),[loading,setLoading]=(0,react.useState)(!0),[error,setError]=(0,react.useState)(null),fetchConversations=(0,react.useCallback)(async()=>{try{const response=await fetch("/api/messages/conversations");if(!response.ok){const errorData=await response.json();throw new Error(errorData.details||"Failed to fetch conversations")}const data=await response.json();setConversations(data.conversations||[]),setError(null)}catch(err){setError(err instanceof Error?err.message:"Failed to load conversations")}finally{setLoading(!1)}},[]);return(0,react.useEffect)(()=>{fetchConversations()},[fetchConversations]),{conversations,setConversations,loading,error,refetch:fetchConversations}}(),{messages,setMessages:_setMessages,loading:messagesLoading}=function useMessages(conversationId){const[messages,setMessages]=(0,react.useState)([]),[loading,setLoading]=(0,react.useState)(!1),fetchMessages=(0,react.useCallback)(async convId=>{setLoading(!0);try{const response=await fetch(`/api/messages/conversations/${convId}`);if(!response.ok)throw new Error("Failed to fetch messages");const data=await response.json();setMessages(data.messages||[])}catch(_err){}finally{setLoading(!1)}},[]),markAsRead=(0,react.useCallback)(async convId=>{try{await fetch(`/api/messages/conversations/${convId}/read`,{method:"POST"})}catch(_err){}},[]);return(0,react.useEffect)(()=>{conversationId&&(fetchMessages(conversationId),markAsRead(conversationId))},[conversationId,fetchMessages,markAsRead]),{messages,setMessages,loading,refetch:fetchMessages}}(selectedConversation?.id||null),autoTranslateEnabled=(0,use_feature_flag.u)("auto_translate_chat"),[translationEnabled,setTranslationEnabled]=(0,react.useState)(!1),[targetLanguage,setTargetLanguage]=(0,react.useState)("en"),[optimisticMessages,addOptimisticMessage]=(0,react.useOptimistic)(messages,(state,newMessage)=>[...state,newMessage]),{permission,supported,requestPermission,showNotification}=function useNotifications(){const[permission,setPermission]=(0,react.useState)("default"),[supported,setSupported]=(0,react.useState)(!1);return(0,react.useEffect)(()=>{"Notification"in window&&(setSupported(!0),setPermission(Notification.permission))},[]),{permission,supported,requestPermission:async()=>{if(!supported)return"denied";try{const result=await Notification.requestPermission();return setPermission(result),result}catch(_error){return"denied"}},showNotification:(title,options)=>{if(!supported||"granted"!==permission)return null;try{return new Notification(title,{icon:"/icon-192x192.png",badge:"/badge-72x72.png",...options})}catch(_error){return null}}}}();(0,react.useEffect)(()=>{if(supported&&"default"===permission){const timer=setTimeout(()=>{requestPermission()},2e3);return()=>clearTimeout(timer)}},[supported,permission,requestPermission]);const handleNewMessage=(0,react.useCallback)(async()=>{await refetchConversations()},[refetchConversations]),handleConversationUpdate=(0,react.useCallback)(async()=>{await refetchConversations()},[refetchConversations]);!function useRealtimeMessages({userId,userRole,selectedConversationId,onNewMessage,onConversationUpdate}){const supabase=(0,browser_client.createSupabaseBrowserClient)(),channelRef=(0,react.useRef)(null);return(0,react.useEffect)(()=>{if(!userId)return;const channel=supabase.channel(`conversations:${userId}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"conversations",filter:"customer"===userRole?`customer_id=eq.${userId}`:`professional_id=eq.${userId}`},_payload=>{onConversationUpdate?.()}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"conversations",filter:"customer"===userRole?`customer_id=eq.${userId}`:`professional_id=eq.${userId}`},_payload=>{onConversationUpdate?.()}).subscribe(status=>{"CHANNEL_ERROR"===status&&use_realtime_messages_console.warn("Conversations channel error")});return channelRef.current=channel,()=>{supabase.removeChannel(channel)}},[userId,userRole,onConversationUpdate,supabase.channel,supabase.removeChannel]),(0,react.useEffect)(()=>{if(!selectedConversationId)return;const messagesChannel=supabase.channel(`messages:${selectedConversationId}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${selectedConversationId}`},payload=>{const newMessage=payload.new;onNewMessage?.(newMessage)}).subscribe(status=>{"CHANNEL_ERROR"===status&&use_realtime_messages_console.warn("Messages channel error")});return()=>{supabase.removeChannel(messagesChannel)}},[selectedConversationId,onNewMessage,supabase.channel,supabase.removeChannel]),{isConnected:"joined"===channelRef.current?.state}}({userId,userRole,selectedConversationId:selectedConversation?.id,onNewMessage:handleNewMessage,onConversationUpdate:handleConversationUpdate}),(0,react.useEffect)(()=>{const currentUnreadCount=function getTotalUnreadCount(conversations,userRole){return conversations.reduce((sum,conv)=>sum+("customer"===userRole?conv.customer_unread_count:conv.professional_unread_count),0)}(conversations,userRole);if(currentUnreadCount>previousUnreadCount&&!document.hasFocus()){const newMessages=currentUnreadCount-previousUnreadCount,latestConversation=conversations.find(conv=>getConversationUnreadCount(conv,userRole)>0);if(latestConversation){const sender=normalizeUser(latestConversation,userRole);showNotification(`New message from ${sender.full_name}`,{body:`You have ${newMessages} unread message${newMessages>1?"s":""}`,tag:"new-message"})}}setPreviousUnreadCount(currentUnreadCount)},[conversations,userRole,previousUnreadCount,showNotification]);return loading?(0,jsx_runtime.jsx)(skeleton.x0,{}):error?(0,jsx_runtime.jsx)("div",{className:"rounded-2xl border border-[#64748b]/30 bg-[#64748b]/10 p-6 text-[#64748b] text-base",children:error}):(0,jsx_runtime.jsxs)("div",{className:"flex h-[calc(100vh-200px)] min-h-[600px] overflow-hidden rounded-xl border border-[#e2e8f0] bg-[#f8fafc] shadow-sm",children:[(0,jsx_runtime.jsxs)("div",{className:"w-96 flex-shrink-0 overflow-y-auto border-[#e2e8f0] border-r",children:[(0,jsx_runtime.jsxs)("div",{className:"border-[#e2e8f0] border-b bg-[#f8fafc] px-6 py-5",children:[(0,jsx_runtime.jsx)("h2",{className:"font-semibold text-[#0f172a] text-xl",children:"Conversations"}),(0,jsx_runtime.jsxs)("p",{className:"mt-1 text-[#94a3b8] text-sm",children:[conversations.length," ",1===conversations.length?"conversation":"conversations"]})]}),(0,jsx_runtime.jsx)("div",{className:"border-[#e2e8f0] border-b bg-[#f8fafc] px-6 py-4",children:(0,jsx_runtime.jsxs)("div",{className:"relative",children:[(0,jsx_runtime.jsx)("input",{className:"w-full rounded-lg border border-[#e2e8f0] px-4 py-2 pl-10 text-[#0f172a] text-sm placeholder-[#94a3b8] focus:border-[#64748b] focus:outline-none focus:ring-1 focus:ring-[#64748b]",placeholder:"Search conversations...",type:"text"}),(0,jsx_runtime.jsx)("svg",{"aria-hidden":"true",className:"absolute top-2.5 left-3 h-5 w-5 text-[#94a3b8]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,jsx_runtime.jsx)("path",{d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})})]})}),0===conversations.length?(0,jsx_runtime.jsx)("div",{className:"p-12 text-center",children:(0,jsx_runtime.jsxs)("div",{className:"mx-auto max-w-xs",children:[(0,jsx_runtime.jsx)("div",{className:"mb-4 flex justify-center",children:(0,jsx_runtime.jsx)("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-[#f8fafc]",children:(0,jsx_runtime.jsx)("svg",{"aria-hidden":"true",className:"h-6 w-6 text-[#94a3b8]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,jsx_runtime.jsx)("path",{d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})})})}),(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-base text-[#0f172a]",children:"No conversations"}),(0,jsx_runtime.jsx)("p",{className:"mt-1 text-[#94a3b8] text-sm",children:"Messages will appear when you book a service"})]})}):(0,jsx_runtime.jsx)("div",{className:"divide-y divide-[#e2e8f0]",children:conversations.map(conv=>{const otherUser=normalizeUser(conv,userRole),unreadCount=getConversationUnreadCount(conv,userRole);return(0,jsx_runtime.jsx)("button",{className:"w-full p-6 text-left transition hover:bg-[#64748b]/5 "+(selectedConversation?.id===conv.id?"bg-[#64748b]/5":""),onClick:()=>{startTransition(()=>{setSelectedConversation(conv)})},type:"button",children:(0,jsx_runtime.jsxs)("div",{className:"flex items-start gap-4",children:[(0,jsx_runtime.jsx)("div",{className:"flex-shrink-0",children:otherUser.avatar_url?(0,jsx_runtime.jsx)(next_image.A,{alt:otherUser.full_name,className:"h-12 w-12 rounded-full object-cover",height:48,loading:"lazy",src:otherUser.avatar_url,width:48}):(0,jsx_runtime.jsx)("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-[#64748b] font-semibold text-base text-[#f8fafc]",children:otherUser.full_name.charAt(0).toUpperCase()})}),(0,jsx_runtime.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,jsx_runtime.jsx)("h3",{className:"truncate font-semibold text-base text-[#0f172a]",children:otherUser.full_name}),unreadCount>0&&(0,jsx_runtime.jsx)("span",{className:"flex h-6 min-w-[24px] items-center justify-center rounded-full bg-[#64748b] px-2 font-semibold text-[#f8fafc] text-xs",children:unreadCount})]}),(0,jsx_runtime.jsxs)("p",{className:"truncate text-[#94a3b8] text-sm",children:["Booking #",conv.booking.id.slice(0,8)]}),conv.last_message_at&&(0,jsx_runtime.jsx)("p",{className:"mt-2 text-[#94a3b8] text-sm",children:(0,formatDistanceToNow.m)(new Date(conv.last_message_at),{addSuffix:!0})})]})]})},conv.id)})})]}),(0,jsx_runtime.jsx)("div",{className:"flex flex-1 flex-col",children:selectedConversation?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsxs)("div",{className:"flex items-center justify-between border-[#e2e8f0] border-b bg-[#f8fafc] px-8 py-5",children:[(()=>{const otherUser=normalizeUser(selectedConversation,userRole);return(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-4",children:[otherUser.avatar_url?(0,jsx_runtime.jsx)(next_image.A,{alt:otherUser.full_name,className:"h-12 w-12 rounded-full object-cover",height:48,loading:"lazy",src:otherUser.avatar_url,width:48}):(0,jsx_runtime.jsx)("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-[#64748b] font-semibold text-base text-[#f8fafc]",children:otherUser.full_name.charAt(0).toUpperCase()}),(0,jsx_runtime.jsxs)("div",{children:[(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-[#0f172a] text-lg",children:otherUser.full_name}),(0,jsx_runtime.jsxs)("p",{className:"text-[#94a3b8] text-sm",children:["Booking #",selectedConversation.booking.id.slice(0,8)," •"," ",new Date(selectedConversation.booking.scheduled_start).toLocaleDateString()]})]})]})})(),(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[autoTranslateEnabled&&(0,jsx_runtime.jsxs)("div",{className:"flex items-center gap-2",children:[(0,jsx_runtime.jsxs)("button",{className:"flex items-center gap-2 rounded-lg px-4 py-2 font-medium text-sm transition "+(translationEnabled?"bg-[#64748b] text-[#f8fafc] hover:bg-[#64748b]":"text-[#94a3b8] hover:bg-[#f8fafc]"),onClick:()=>setTranslationEnabled(!translationEnabled),type:"button",children:[(0,jsx_runtime.jsx)(HugeiconsIcon.n,{className:"h-4 w-4",icon:index_min.SwB}),translationEnabled?"Translation On":"Translate"]}),translationEnabled&&(0,jsx_runtime.jsxs)("select",{className:"rounded-lg border border-[#e2e8f0] px-3 py-2 text-sm focus:border-[#64748b] focus:outline-none focus:ring-1 focus:ring-[#64748b]",onChange:e=>setTargetLanguage(e.target.value),value:targetLanguage,children:[(0,jsx_runtime.jsx)("option",{value:"en",children:"English"}),(0,jsx_runtime.jsx)("option",{value:"es",children:"Español"})]})]}),(0,jsx_runtime.jsx)("button",{className:"rounded-lg px-4 py-2 font-medium text-[#94a3b8] text-sm transition hover:bg-[#f8fafc]",type:"button",children:"View Booking"})]})]}),(0,jsx_runtime.jsx)(MessageThread,{currentUserId:userId,loading:messagesLoading,messages:optimisticMessages,targetLanguage,translationEnabled}),(0,jsx_runtime.jsx)(MessageInput,{isPending,onSend:async messageText=>{if(!selectedConversation||!messageText.trim())return;const optimisticMessage={id:`temp-${Date.now()}`,conversation_id:selectedConversation.id,sender_id:userId,message:messageText,attachments:[],read_at:null,created_at:(new Date).toISOString(),sender:{id:userId,full_name:"You",avatar_url:void 0}};addOptimisticMessage(optimisticMessage);try{if(!(await fetch(`/api/messages/conversations/${selectedConversation.id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:messageText})})).ok)throw new Error("Failed to send message")}catch(err){messaging_interface_console.error("Failed to send message:",err),toast.o.error("Failed to send message. Please try again.")}},userRole})]}):(0,jsx_runtime.jsx)("div",{className:"flex flex-1 items-center justify-center p-12",children:(0,jsx_runtime.jsxs)("div",{className:"max-w-sm text-center",children:[(0,jsx_runtime.jsx)("div",{className:"mb-4 flex justify-center",children:(0,jsx_runtime.jsx)("div",{className:"flex h-16 w-16 items-center justify-center rounded-full bg-[#f8fafc]",children:(0,jsx_runtime.jsx)("svg",{"aria-hidden":"true",className:"h-8 w-8 text-[#94a3b8]",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,jsx_runtime.jsx)("path",{d:"M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2})})})}),(0,jsx_runtime.jsx)("h3",{className:"font-semibold text-[#0f172a] text-xl",children:"Select a conversation"}),(0,jsx_runtime.jsx)("p",{className:"mt-2 text-base text-[#94a3b8]",children:"Choose a conversation from the list to start messaging"})]})})})]})}function MessageThread({messages,currentUserId,loading,translationEnabled,targetLanguage}){const messagesEndRef=(0,react.useRef)(null),{translations,translatingIds}=function useMessageTranslation(messages,translationEnabled,targetLanguage){const[translations,setTranslations]=(0,react.useState)({}),[translatingIds,setTranslatingIds]=(0,react.useState)(new Set);return(0,react.useEffect)(()=>{translationEnabled?(async()=>{for(const msg of messages){if(translations[msg.id]||translatingIds.has(msg.id))continue;const sourceLang=detectLanguage(msg.message);if(sourceLang!==targetLanguage){setTranslatingIds(prev=>new Set([...prev,msg.id]));try{const result=await translateText(msg.message,sourceLang,targetLanguage);setTranslations(prev=>({...prev,[msg.id]:result.translatedText}))}catch{}finally{setTranslatingIds(prev=>{const next=new Set(prev);return next.delete(msg.id),next})}}}})():setTranslations({})},[translationEnabled,messages,targetLanguage,translations,translatingIds]),{translations,translatingIds}}(messages,translationEnabled,targetLanguage);return(0,react.useEffect)(()=>{messagesEndRef.current?.scrollIntoView({behavior:"smooth"})},[]),loading&&0===messages.length?(0,jsx_runtime.jsx)("div",{className:"flex flex-1 items-center justify-center",children:(0,jsx_runtime.jsx)("p",{className:"text-base text-[#94a3b8]",children:"Loading messages..."})}):(0,jsx_runtime.jsxs)("div",{className:"flex-1 space-y-6 overflow-y-auto p-6",children:[0===messages.length?(0,jsx_runtime.jsx)("div",{className:"flex h-full items-center justify-center",children:(0,jsx_runtime.jsx)("p",{className:"text-base text-[#94a3b8]",children:"No messages yet. Start the conversation!"})}):messages.map(msg=>{const isCurrentUser=msg.sender_id===currentUserId,hasTranslation=translationEnabled&&translations[msg.id],isTranslating=translationEnabled&&translatingIds.has(msg.id);return(0,jsx_runtime.jsx)("div",{className:"flex "+(isCurrentUser?"justify-end":"justify-start"),children:(0,jsx_runtime.jsxs)("div",{className:"max-w-[70%] rounded-xl px-4 py-3 "+(isCurrentUser?"bg-[#64748b] text-[#f8fafc]":"bg-[#f8fafc] text-[#0f172a]"),children:[hasTranslation?(0,jsx_runtime.jsxs)(jsx_runtime.Fragment,{children:[(0,jsx_runtime.jsx)("p",{className:"text-base leading-relaxed",children:translations[msg.id]}),(0,jsx_runtime.jsxs)("details",{className:"mt-2",children:[(0,jsx_runtime.jsx)("summary",{className:"cursor-pointer text-xs "+(isCurrentUser?"text-[#f8fafc]/70":"text-[#94a3b8]"),children:"Show original"}),(0,jsx_runtime.jsx)("p",{className:"mt-1 text-sm "+(isCurrentUser?"text-[#f8fafc]/90":"text-[#0f172a]"),children:msg.message})]})]}):(0,jsx_runtime.jsx)("p",{className:"text-base leading-relaxed",children:msg.message}),isTranslating&&(0,jsx_runtime.jsx)("p",{className:"mt-1 text-xs "+(isCurrentUser?"text-[#f8fafc]/70":"text-[#94a3b8]"),children:"Translating..."}),(0,jsx_runtime.jsx)("p",{className:"mt-2 text-sm "+(isCurrentUser?"text-[#f8fafc]/70":"text-[#94a3b8]"),children:(0,formatDistanceToNow.m)(new Date(msg.created_at),{addSuffix:!0})})]})},msg.id)}),(0,jsx_runtime.jsx)("div",{ref:messagesEndRef})]})}const CONTACT_PATTERNS=[{pattern:/\d{10,}/,name:"phone number"},{pattern:/@[a-zA-Z0-9.-]+\.(com|co|net|org|edu)/i,name:"email"},{pattern:/whatsapp/i,name:"WhatsApp"},{pattern:/telegram/i,name:"Telegram"},{pattern:/\b\d{3}[-.\s]?\d{3}[-.\s]?\d{4}\b/,name:"phone number"}];function MessageInput({onSend,isPending,userRole}){const[message,setMessage]=(0,react.useState)(""),[hasShownWarning,setHasShownWarning]=(0,react.useState)(!1),inputRef=(0,react.useRef)(null),[_state,formAction,isFormPending]=(0,react.useActionState)(async(_prevState,formData)=>{const messageText=formData.get("message");return messageText?.trim()&&(await onSend(messageText),setMessage(""),setHasShownWarning(!1),inputRef.current?.focus()),{success:!0}},{success:!1}),isSending=isFormPending||isPending;return(0,jsx_runtime.jsxs)("form",{action:formAction,className:"space-y-4 border-[#e2e8f0] border-t bg-[#f8fafc] p-6",children:["professional"===userRole&&(0,jsx_runtime.jsx)(quick_replies.y,{onSelectReply:replyMessage=>{setMessage(replyMessage),inputRef.current?.focus()}}),(0,jsx_runtime.jsxs)("div",{className:"flex gap-3",children:[(0,jsx_runtime.jsx)("input",{className:"flex-1 rounded-xl border border-[#e2e8f0] px-4 py-4 text-base shadow-sm focus:border-[#64748b] focus:outline-none focus:ring-2 focus:ring-[#64748b]/20 disabled:opacity-50",disabled:isSending,name:"message",onChange:e=>{const newMessage=e.target.value;if(setMessage(newMessage),!hasShownWarning&&newMessage.trim()){const detectedContact=function detectContactSharing(text){for(const{pattern,name}of CONTACT_PATTERNS)if(pattern.test(text))return name;return null}(newMessage);detectedContact&&(toast.o.warning(`Reminder: Keep communication in-app until booking is confirmed. Sharing ${detectedContact} may violate our terms.`,5e3),setHasShownWarning(!0))}},placeholder:"Type a message...",ref:inputRef,type:"text",value:message}),(0,jsx_runtime.jsx)("button",{className:"rounded-full bg-[#64748b] px-6 py-4 font-semibold text-base text-[#f8fafc] transition hover:bg-[#64748b] disabled:cursor-not-allowed disabled:opacity-50",disabled:!message.trim()||isSending,type:"submit",children:isSending?"Sending...":"Send"})]})]})}try{MessagingInterface.displayName="MessagingInterface",MessagingInterface.__docgenInfo={description:"",displayName:"MessagingInterface",props:{userId:{defaultValue:null,description:"",name:"userId",required:!0,type:{name:"string"}},userRole:{defaultValue:null,description:"",name:"userRole",required:!0,type:{name:"enum",value:[{value:'"customer"'},{value:'"professional"'}]}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/messaging/messaging-interface.tsx#MessagingInterface"]={docgenInfo:MessagingInterface.__docgenInfo,name:"MessagingInterface",path:"src/components/messaging/messaging-interface.tsx#MessagingInterface"})}catch(__react_docgen_typescript_loader_error){}const messaging_interface_stories={title:"Messaging/MessagingInterface",component:MessagingInterface,parameters:{layout:"padded"},tags:["autodocs"]},Default={},__namedExportsOrder=["Default"]},"./src/components/messaging/quick-replies.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{y:()=>QuickReplies});var react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/jsx-runtime.js"),_hugeicons_core_free_icons__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/@hugeicons/core-free-icons/dist/esm/index.min.js"),_hugeicons_react__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/@hugeicons/react/dist/esm/HugeiconsIcon.js"),react__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js");const QUICK_REPLIES=[{id:"accept-1",label:"Accept - Available",message:"Hello! I'd be happy to help with your booking. I'm available at the requested time. Looking forward to working with you!",category:"acceptance"},{id:"accept-2",label:"Accept - Confirm Details",message:"Thank you for your request! I can accommodate this booking. Just to confirm the service details and address - could you verify everything looks correct?",category:"acceptance"},{id:"question-1",label:"Ask About Details",message:"Thanks for reaching out! I have a few questions to ensure I can provide the best service:\n\n1. Approximate square footage?\n2. Any specific areas needing extra attention?\n3. Any pets in the home?",category:"questions"},{id:"question-2",label:"Ask About Access",message:"I'd love to help! Quick question about access: Will someone be home, or should we arrange a key pickup/lockbox access?",category:"questions"},{id:"question-3",label:"Ask About Supplies",message:"I can definitely help! Do you have cleaning supplies and equipment, or would you prefer I bring my own? (Additional fee may apply)",category:"questions"},{id:"schedule-1",label:"Propose Alternative Time",message:"Thank you for your booking request! I'm unfortunately not available at that exact time, but I have openings:\n\n• [Time option 1]\n• [Time option 2]\n\nWould either of these work for you?",category:"scheduling"},{id:"schedule-2",label:"Confirm Timing",message:"Perfect! I have you scheduled for [date/time]. I'll plan to arrive promptly and complete the service within [duration]. See you then!",category:"scheduling"},{id:"schedule-3",label:"Running Late",message:"Hi! I'm running about 15-20 minutes behind schedule due to traffic. I apologize for the inconvenience and will be there as soon as possible!",category:"scheduling"},{id:"general-1",label:"Thank You",message:"Thank you so much for choosing my services! I really appreciate your business and look forward to helping you again in the future.",category:"general"},{id:"general-2",label:"Follow Up",message:"Hi! I wanted to follow up on our last service. I hope everything was to your satisfaction. Please let me know if you need anything or would like to schedule another appointment!",category:"general"},{id:"general-3",label:"Unavailable",message:"Thank you for your interest! Unfortunately, I'm not available for this booking. I recommend checking out other professionals on the platform who may be able to help.",category:"general"}];function QuickReplies({onSelectReply}){const[isExpanded,setIsExpanded]=(0,react__WEBPACK_IMPORTED_MODULE_3__.useState)(!1),[selectedCategory,setSelectedCategory]=(0,react__WEBPACK_IMPORTED_MODULE_3__.useState)("all"),filteredReplies="all"===selectedCategory?QUICK_REPLIES:QUICK_REPLIES.filter(r=>r.category===selectedCategory),categoryLabels={all:"All Templates",acceptance:"Acceptances",questions:"Questions",scheduling:"Scheduling",general:"General"};return isExpanded?(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("div",{className:"rounded-lg border border-slate-200 bg-white p-4 shadow-sm",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("div",{className:"mb-3 flex items-center justify-between",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("h3",{className:"font-semibold text-slate-900 text-sm",children:"Quick Reply Templates"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("button",{className:"text-slate-500 transition hover:text-slate-700",onClick:()=>setIsExpanded(!1),type:"button",children:(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_hugeicons_react__WEBPACK_IMPORTED_MODULE_2__.n,{className:"h-5 w-5",icon:_hugeicons_core_free_icons__WEBPACK_IMPORTED_MODULE_1__.p_k})})]}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("div",{className:"mb-3 flex gap-2 overflow-x-auto",children:["all","acceptance","questions","scheduling","general"].map(category=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("button",{className:"whitespace-nowrap rounded-full px-3 py-1 font-medium text-xs transition "+(selectedCategory===category?"bg-slate-900 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),onClick:()=>setSelectedCategory(category),type:"button",children:categoryLabels[category]},category))}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("div",{className:"grid max-h-64 grid-cols-1 gap-2 overflow-y-auto sm:grid-cols-2",children:filteredReplies.map(reply=>(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("button",{className:"rounded-lg border border-slate-200 bg-slate-50 px-4 py-3 text-left text-sm transition hover:border-slate-300 hover:bg-slate-100",onClick:()=>{onSelectReply(reply.message),setIsExpanded(!1)},type:"button",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("div",{className:"mb-1 font-medium text-slate-900",children:reply.label}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("div",{className:"line-clamp-2 text-slate-600 text-xs",children:reply.message})]},reply.id))}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("p",{className:"mt-3 text-center text-slate-500 text-xs",children:"Click a template to insert it into your message. You can edit it before sending."})]}):(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsxs)("button",{className:"flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-4 py-2 font-medium text-slate-700 text-sm shadow-sm transition-all hover:border-slate-300 hover:bg-slate-50",onClick:()=>setIsExpanded(!0),type:"button",children:[(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)("span",{children:"Quick Replies"}),(0,react_jsx_runtime__WEBPACK_IMPORTED_MODULE_0__.jsx)(_hugeicons_react__WEBPACK_IMPORTED_MODULE_2__.n,{className:"h-4 w-4",icon:_hugeicons_core_free_icons__WEBPACK_IMPORTED_MODULE_1__.eWi})]})}try{QuickReplies.displayName="QuickReplies",QuickReplies.__docgenInfo={description:"",displayName:"QuickReplies",props:{onSelectReply:{defaultValue:null,description:"",name:"onSelectReply",required:!0,type:{name:"(message: string) => void"}}}},"undefined"!=typeof STORYBOOK_REACT_CLASSES&&(STORYBOOK_REACT_CLASSES["src/components/messaging/quick-replies.tsx#QuickReplies"]={docgenInfo:QuickReplies.__docgenInfo,name:"QuickReplies",path:"src/components/messaging/quick-replies.tsx#QuickReplies"})}catch(__react_docgen_typescript_loader_error){}},"./src/hooks/use-feature-flag.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{u:()=>useFeatureFlag});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/next/dist/compiled/react/index.js"),_lib_feature_flags__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/lib/feature-flags.ts");function useFeatureFlag(flag,userId){return(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)(()=>(0,_lib_feature_flags__WEBPACK_IMPORTED_MODULE_1__.G7)(flag,userId),[flag,userId])}},"./src/lib/feature-flags.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{G7:()=>isFeatureEnabled});var process=__webpack_require__("./node_modules/process/browser.js");const defaultFlags={show_match_wizard:!0,enable_web_vitals:!1,enhanced_trust_badges:!1,live_price_breakdown:!1,show_on_time_metrics:!1,auto_translate_chat:!0,one_tap_rebook:!0,recurring_plans:!0,rebook_nudge_system:!0,gps_check_in_out:!0,arrival_notifications:!0,time_extension_ui:!0,show_amara_assistant:!0,admin_verification_queue:!0,payout_ledger:!1,city_landing_pages:!0,show_platform_fee:!1,enable_tipping:!0,subscription_discount_badges:!1,caregiver_profiles:!1,maintenance_reminders:!1,referral_program:!0};function isFeatureEnabled(flag,userId){const envOverride=function getEnvOverride(flag){const envKey=`NEXT_PUBLIC_FEATURE_${flag.toUpperCase()}`,envValue=process.env[envKey];if(void 0!==envValue)return"true"===envValue||"1"===envValue}(flag);return void 0!==envOverride?envOverride:!(!userId||!function isBetaTester(userId,flag){const betaTesters={show_match_wizard:[],recurring_plans:[]};return betaTesters[flag]?.includes(userId)??!1}(userId,flag))||defaultFlags[flag]}},"./src/lib/supabase/browser-client.ts":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{createSupabaseBrowserClient:()=>createSupabaseBrowserClient});var _supabase_ssr__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/@supabase/ssr/dist/module/index.js");function createSupabaseBrowserClient(){const supabaseUrl="https://hvnetxfsrtplextvtwfx.supabase.co",supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2bmV0eGZzcnRwbGV4dHZ0d2Z4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1ODc0NTEsImV4cCI6MjA3NzE2MzQ1MX0.7-N06om_ntUuGP1NZ0Zcqz01s975xJfiKno34aIW__o";return(0,_supabase_ssr__WEBPACK_IMPORTED_MODULE_0__.createBrowserClient)(supabaseUrl,supabaseKey)}}}]);