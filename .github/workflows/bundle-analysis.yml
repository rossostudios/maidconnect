name: Bundle Size Analysis

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'bun.lock'
      - 'next.config.ts'
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'bun.lock'
      - 'next.config.ts'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: write # For PR comments

jobs:
  analyze-bundle:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build production bundle
        run: bun run build
        env:
          NODE_ENV: production
          # Placeholder values for bundle analysis (build only, no runtime behavior)
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key-for-bundle-analysis

      - name: Analyze bundle size
        id: analyze
        run: |
          echo "## ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get total bundle size
          TOTAL_SIZE=$(du -sh .next/static | awk '{print $1}')
          echo "**Total Static Size:** $TOTAL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Top 10 largest JavaScript chunks
          echo "### Top 10 Largest JavaScript Chunks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          find .next/static/chunks -name "*.js" -type f -exec ls -lh {} \; | \
            awk '{print $9, $5}' | \
            sort -k2 -h -r | \
            head -10 | \
            awk '{printf "| `%s` | %s |\n", $1, $2}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # CSS bundles
          echo "### CSS Bundles" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next/static/css" ]; then
            echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------|" >> $GITHUB_STEP_SUMMARY
            find .next/static/css -name "*.css" -type f -exec ls -lh {} \; | \
              awk '{printf "| `%s` | %s |\n", $9, $5}' >> $GITHUB_STEP_SUMMARY
          else
            echo "No CSS bundles found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Save total size for comparison
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT

      - name: Check bundle size budget
        id: budget
        run: |
          # Define size budgets (in KB)
          MAX_JS_CHUNK_SIZE=250
          MAX_TOTAL_SIZE=30000  # 30 MB

          # Check for chunks exceeding budget
          OVER_BUDGET=$(find .next/static/chunks -name "*.js" -type f -size +${MAX_JS_CHUNK_SIZE}k | wc -l)

          if [ $OVER_BUDGET -gt 0 ]; then
            echo "âš ï¸ **Warning:** $OVER_BUDGET JavaScript chunk(s) exceed ${MAX_JS_CHUNK_SIZE}KB budget" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Chunks Over Budget:" >> $GITHUB_STEP_SUMMARY
            find .next/static/chunks -name "*.js" -type f -size +${MAX_JS_CHUNK_SIZE}k -exec ls -lh {} \; | \
              awk '{printf "- `%s`: %s\n", $9, $5}' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All chunks within ${MAX_JS_CHUNK_SIZE}KB budget" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with bundle analysis
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“¦ Bundle Size Analysis')
            );

            const commentBody = `${summary}\n\n---\n*Updated: ${new Date().toISOString()}*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats
          path: |
            .next/static/chunks/**/*.js
            .next/static/css/**/*.css
          retention-days: 7
