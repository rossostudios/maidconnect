name: Bundle Size Analysis

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'bun.lock'
      - 'next.config.ts'
      - 'lighthouserc.js'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'bun.lock'
      - 'next.config.ts'
  workflow_dispatch:
    inputs:
      skip_lighthouse:
        description: 'Skip Lighthouse CI'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  pull-requests: write

env:
  NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
  NEXT_PUBLIC_SUPABASE_ANON_KEY: placeholder-anon-key-for-bundle-analysis
  NEXT_PUBLIC_SANITY_PROJECT_ID: placeholder
  NEXT_PUBLIC_SANITY_DATASET: production

jobs:
  build-baseline:
    name: Build Baseline
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build production bundle
        run: bun run build
        env:
          NODE_ENV: production

      - name: Generate baseline stats
        run: ./scripts/bundle-stats.sh baseline-stats.json

      - name: Upload baseline stats
        uses: actions/upload-artifact@v4
        with:
          name: baseline-stats
          path: baseline-stats.json
          retention-days: 1

  analyze-bundle:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [build-baseline]
    if: always() && (github.event_name == 'pull_request' || github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    outputs:
      status: ${{ steps.compare.outputs.status }}
      total_js: ${{ steps.stats.outputs.total_js }}
      diff_percent: ${{ steps.compare.outputs.diff_percent }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build production bundle
        run: bun run build
        env:
          NODE_ENV: production

      - name: Generate current stats
        id: stats
        run: |
          ./scripts/bundle-stats.sh bundle-stats.json
          TOTAL_JS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('bundle-stats.json')).totalJs)")
          echo "total_js=$TOTAL_JS" >> "$GITHUB_OUTPUT"

      - name: Download baseline stats
        if: github.event_name == 'pull_request' && needs.build-baseline.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: baseline-stats
        continue-on-error: true

      - name: Create fallback baseline
        if: github.event_name != 'pull_request' || needs.build-baseline.result != 'success'
        run: cp bundle-stats.json baseline-stats.json

      - name: Compare bundles
        id: compare
        run: |
          set +e
          ./scripts/compare-bundles.sh baseline-stats.json bundle-stats.json comparison-report.md
          EXIT_CODE=$?
          set -e

          if [ -f "baseline-stats.json" ] && [ -f "bundle-stats.json" ]; then
            BASELINE=$(node -e "console.log(JSON.parse(require('fs').readFileSync('baseline-stats.json')).totalJs)")
            CURRENT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('bundle-stats.json')).totalJs)")
            if [ "$BASELINE" -gt 0 ]; then
              DIFF_PERCENT=$(node -e "console.log((($CURRENT - $BASELINE) / $BASELINE * 100).toFixed(2))")
            else
              DIFF_PERCENT="0.00"
            fi
          else
            DIFF_PERCENT="0.00"
          fi

          echo "diff_percent=$DIFF_PERCENT" >> "$GITHUB_OUTPUT"

          case $EXIT_CODE in
            0)
              echo "status=pass" >> "$GITHUB_OUTPUT"
              echo "## âœ… Bundle Analysis: PASS" >> "$GITHUB_STEP_SUMMARY"
              ;;
            2)
              echo "status=warn" >> "$GITHUB_OUTPUT"
              echo "## âš ï¸ Bundle Analysis: WARNING" >> "$GITHUB_STEP_SUMMARY"
              ;;
            *)
              echo "status=fail" >> "$GITHUB_OUTPUT"
              echo "## âŒ Bundle Analysis: FAIL" >> "$GITHUB_STEP_SUMMARY"
              ;;
          esac

          cat comparison-report.md >> "$GITHUB_STEP_SUMMARY"
          exit $EXIT_CODE

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}
          path: |
            bundle-stats.json
            comparison-report.md
          retention-days: 30

      - name: Cache baseline for main branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/cache/save@v4
        with:
          path: bundle-stats.json
          key: bundle-baseline-main-${{ github.sha }}

  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [analyze-bundle]
    if: |
      always() &&
      needs.analyze-bundle.result != 'cancelled' &&
      (github.event.inputs.skip_lighthouse != 'true')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build production bundle
        run: bun run build
        env:
          NODE_ENV: production

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.14.x

      - name: Run Lighthouse CI
        id: lhci
        run: |
          lhci autorun --config=lighthouserc.js || EXIT_CODE=$?

          echo "## ðŸ”¦ Lighthouse CI Results" >> "$GITHUB_STEP_SUMMARY"

          if [ -d ".lighthouseci" ]; then
            for json in .lighthouseci/lhr-*.json; do
              if [ -f "$json" ]; then
                URL=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$json')).finalUrl)")
                PERF=$(node -e "console.log(Math.round(JSON.parse(require('fs').readFileSync('$json')).categories.performance.score * 100))")
                A11Y=$(node -e "console.log(Math.round(JSON.parse(require('fs').readFileSync('$json')).categories.accessibility.score * 100))")
                BP=$(node -e "console.log(Math.round(JSON.parse(require('fs').readFileSync('$json'))?.categories?.['best-practices']?.score * 100 || 0))")
                SEO=$(node -e "console.log(Math.round(JSON.parse(require('fs').readFileSync('$json')).categories.seo.score * 100))")
                LCP=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$json')).audits['largest-contentful-paint'].numericValue.toFixed(0))")
                CLS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$json')).audits['cumulative-layout-shift'].numericValue.toFixed(3))")
                TBT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('$json')).audits['total-blocking-time'].numericValue.toFixed(0))")

                {
                  echo ""
                  echo "### $URL"
                  echo "| Category | Score |"
                  echo "|----------|-------|"
                  echo "| Performance | $PERF |"
                  echo "| Accessibility | $A11Y |"
                  echo "| Best Practices | $BP |"
                  echo "| SEO | $SEO |"
                  echo ""
                  echo "**Core Web Vitals:** LCP: ${LCP}ms | CLS: $CLS | TBT: ${TBT}ms"
                } >> "$GITHUB_STEP_SUMMARY"
              fi
            done
          fi

          exit ${EXIT_CODE:-0}
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports-${{ github.sha }}
          path: .lighthouseci/
          retention-days: 30

  comment-pr:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [analyze-bundle, lighthouse]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Download bundle stats
        uses: actions/download-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}
        continue-on-error: true

      - name: Comment PR with analysis
        uses: actions/github-script@v7
        env:
          BUNDLE_STATUS: ${{ needs.analyze-bundle.outputs.status }}
          LIGHTHOUSE_RESULT: ${{ needs.lighthouse.result }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let bundleReport = '';
            try {
              bundleReport = fs.readFileSync('comparison-report.md', 'utf8');
            } catch (e) {
              bundleReport = '> Bundle comparison report not available';
            }

            const bundleStatus = process.env.BUNDLE_STATUS || 'unknown';
            const bundleBadge = bundleStatus === 'pass' ? 'âœ…' : bundleStatus === 'warn' ? 'âš ï¸' : 'âŒ';

            const lighthouseResult = process.env.LIGHTHOUSE_RESULT || 'unknown';
            const lighthouseBadge = lighthouseResult === 'success' ? 'âœ…' : lighthouseResult === 'skipped' ? 'â­ï¸' : 'âŒ';

            const shortSha = context.sha.substring(0, 7);
            const artifactsUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Build table using array to avoid YAML parsing issues with | at line start
            const tableRows = [
              '| Check | Status |',
              '|-------|--------|',
              `| Bundle Size | ${bundleBadge} ${bundleStatus.toUpperCase()} |`,
              `| Lighthouse CI | ${lighthouseBadge} ${lighthouseResult.toUpperCase()} |`,
            ].join('\n');

            const commentBody = `## ðŸ“¦ Bundle & Performance Analysis\n\n${tableRows}\n\n${bundleReport}\n\n---\n*Commit: ${shortSha} | [View Artifacts](${artifactsUrl})*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“¦ Bundle & Performance Analysis')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

  store-metrics:
    name: Store Historical Metrics
    runs-on: ubuntu-latest
    needs: [analyze-bundle]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download bundle stats
        uses: actions/download-artifact@v4
        with:
          name: bundle-stats-${{ github.sha }}

      - name: Store metrics in Supabase
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          STATS=$(cat bundle-stats.json)
          TOTAL_JS=$(echo "$STATS" | jq '.totalJs')
          TOTAL_CSS=$(echo "$STATS" | jq '.totalCss')
          CHUNKS_COUNT=$(echo "$STATS" | jq '.summary.totalChunks')
          OVER_250KB=$(echo "$STATS" | jq '.summary.over250kb')
          OVER_300KB=$(echo "$STATS" | jq '.summary.over300kb')
          LARGEST_CHUNK=$(echo "$STATS" | jq -r '.summary.largestChunk.name // "none"')
          LARGEST_SIZE=$(echo "$STATS" | jq '.summary.largestChunk.size // 0')

          if [ -n "$SUPABASE_KEY" ]; then
            curl -X POST "${SUPABASE_URL}/rest/v1/bundle_metrics" \
              -H "apikey: ${SUPABASE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_KEY}" \
              -H "Content-Type: application/json" \
              -H "Prefer: return=minimal" \
              -d "{
                \"commit_sha\": \"${COMMIT_SHA}\",
                \"branch\": \"main\",
                \"total_js_bytes\": $TOTAL_JS,
                \"total_css_bytes\": $TOTAL_CSS,
                \"chunks_count\": $CHUNKS_COUNT,
                \"chunks_over_250kb\": $OVER_250KB,
                \"chunks_over_300kb\": $OVER_300KB,
                \"largest_chunk_name\": \"$LARGEST_CHUNK\",
                \"largest_chunk_bytes\": $LARGEST_SIZE,
                \"raw_stats\": $STATS
              }"
            echo "Metrics stored successfully"
          else
            echo "Skipping metrics storage (SUPABASE_SERVICE_ROLE_KEY not configured)"
          fi
